---
title: "Component Levels Report"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
    toc: true
    toc_depth: 4
params:
  export_path: 
    label: "Path to directory with component data"
    value: I:/ManualVsBond/Test
    input: file
---

<style type="text/css">
body {
    max-width: 800px;
}

table {
    width: auto !important;
    max-width: 100%;
    margin-bottom: 20px;
    margin-left: 0px;
}

.fill-cell>tbody>tr>td {
  padding: 0px;
  border-color: black;
  border: 1px solid;
}

.fill-cell>thead>tr>th {
  border-color: black;
  border: 1px solid;
}

img {
  border: none;
}
</style>

```{r setup, echo=FALSE,include=FALSE,message=FALSE}
knitr::opts_chunk$set(echo=FALSE,fig.width=9, fig.height=6, 
                      comment=NA, warning=FALSE, message=FALSE)

library(dplyr)
library(formattable)
library(phenoptr)

export_path = params$export_path
quantiles = c(0.1, 0.99)

```

This report shows component levels for samples
from <pre><strong>`r export_path`</strong></pre>.

```{r data}
comp_files = list.files(export_path, pattern='component_data.tif', full.names=TRUE) %>% 
  purrr::set_names(., basename(.))
if (length(comp_files) == 0)
  stop('No component data files found at "', export_path, '"')

```

### Pixel intensity by image

These plots show the number of pixels at each intensity for each
component of each image.
Intensity is shown on a log scale.

```{r}
# Initial data acquisition and creation of the first round of plots
# all_data is a list of lists of plot, data, quants, clipping
all_data = purrr::map(comp_files, phenoptrReports:::component_ridge_plot, quantiles=quantiles)

# Save some data
all_quants = purrr::map_dfr(all_data, 'quants')
readr::write_csv(all_quants, file.path(export_path, 'all_quants.csv'))

all_clipping = purrr::map_dfr(all_data, 'clipping')
readr::write_csv(all_clipping, file.path(export_path, 'all_clipping.csv'))

all_components = purrr::map_dfr(all_data, 'data')
density_fig_height =  1 + 0.5 * n_distinct(all_components$Fluor)
```

```{r fig.height=density_fig_height,results='asis'}
# Output density plots by file
message('Creating histograms by source')
purrr::iwalk(all_data, function(d, n) {
  message('Processing ', n)
  print(d$plot)
  cat('\n\n  \n----\n  \n')
})

component_fig_height = 1 + 0.5 * n_distinct(all_components$Source)
```


### Pixel intensity by component

```{r fig.height=component_fig_height,results='asis'}
message('Creating histograms by component')
fluors = sort(unique(all_components$Fluor))
palette = RColorBrewer::brewer.pal(length(fluors), 'Spectral')

purrr::walk2(fluors, palette, 
   function(fluor, fill) {
     print(phenoptrReports:::fluor_ridge_plot(
       all_components %>% filter(Fluor==fluor),
       all_quants %>% filter(Fluor==fluor), 
       all_clipping %>% filter(Fluor==fluor),
       fluor, fill))
    cat('\n\n  \n----\n  \n')
})

```

### Pair plots

Pair plots show the expression of each marker against each other marker.
They may help identify crosstalk between markers.

```{r fig.width=8,fig.height=8.5,results='asis'}
message('Creating pair plots')
purrr::iwalk(all_data, function(d, n) {
  # Unstack and subsample
  message('Processing ', n)
  d = d$data %>% select(-Source) %>% unstack(value ~ Fluor) %>% sample_n(2000)
  pairs(d, pch='.', cex=3, col=scales::alpha('black', 0.2),
              main=n)
  cat('\n\n  \n----\n  \n')
})
```

### Signal to noise

This table shows the ratio of the `r scales::percent(quantiles[2])`ile signal
level to the `r scales::percent(quantiles[1])`ile signal level.

```{r}
all_quants %>% dplyr::mutate(SN=round(.[[4]]/.[[3]], 1)) %>% 
  dplyr::select(Fluor, Source, SN) %>% 
  tidyr::spread(Fluor, SN) %>% 
  knitr::kable()
```

<br><br><br>
<p align='center'>![](Akoya.png){height=50px style='border:none;'}</p>
